// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Модель пользователя
model User {
  id        Int      @id @default(autoincrement())
  telegramId String  @unique
  publicId  String?  @unique // Публичный ID для отображения (например, "U123456")
  username  String?
  balance   Int      @default(0)
  firstDepositMade Boolean @default(false) // Флаг первого пополнения для бонуса х2
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  videos    Video[]
  referrals Referral[]
  transactions Transaction[]
}

// Модель видео
model Video {
  id          Int      @id @default(autoincrement())
  title       String
  prompt      String   // Описание для генерации
  telegramFileId String? // ID файла в Telegram (null пока не сгенерировано)
  thumbnailFileId String? // ID превью в Telegram

  // Параметры генерации
  model       String   @default("sora-2") // Модель: "sora-2", "veo-3-fast"
  duration    Int      @default(5) // Длительность в секундах: 5, 10, 15
  tokensCost  Int      // Стоимость в токенах: 29, 49, 69
  status      String   @default("pending") // pending, processing, completed, failed
  errorMessage String? // Сообщение об ошибке если failed
  kieJobId    String?  // ID задачи в KIE.AI для отслеживания

  createdAt   DateTime @default(now())
  completedAt DateTime? // Когда генерация завершилась
  userId      Int
  user        User     @relation(fields: [userId], references: [id])

  // Поля для публичной галереи
  isPublic    Boolean  @default(false) // Опубликовано ли видео в галерее
  votes       Vote[]   // Голоса за видео
  votesCount  Int      @default(0)     // Кэш количества голосов

  // Поля для аукциона "Видео дня"
  isFeatured  Boolean  @default(false) // Находится ли на главной позиции
  currentBid  Int      @default(0)     // Текущая ставка в токенах
  featuredAt  DateTime? // Когда было поставлено на главную
  featuredUntil DateTime? // До какого времени будет на главной (24 часа)

  @@index([isPublic, votesCount])
  @@index([isFeatured, featuredUntil])
  @@index([userId, status])
  @@index([status, createdAt])
}

// Модель реферальной системы
model Referral {
  id          Int      @id @default(autoincrement())
  referrerId  Int      // ID пользователя, который пригласил
  referredId  Int      // ID приглашенного пользователя
  createdAt   DateTime @default(now())
  referrer    User     @relation(fields: [referrerId], references: [id])
}

// Модель недельной статистики рефералов для лидерборда
model WeeklyReferralStats {
  id            Int      @id @default(autoincrement())
  referrerId    Int      // ID реферера
  weekStart     DateTime // Начало недели (понедельник 00:00)
  weekEnd       DateTime // Конец недели (воскресенье 23:59)
  newReferrals  Int      @default(0) // Количество НОВЫХ рефералов, приглашенных за эту неделю
  totalSpending Int      @default(0) // Общая сумма трат ВСЕХ рефералов за неделю (и старых, и новых)
  payoutAmount  Int      @default(0) // Сумма выплаты (рассчитывается в конце недели)
  payoutPercent Int      @default(0) // Процент выплаты (15%, 13%, 11%, 10%)
  leaderboardPosition Int? // Позиция в лидерборде (определяется по newReferrals)
  isPaid        Boolean  @default(false) // Выплачено ли
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([referrerId, weekStart])
  @@index([weekStart, newReferrals]) // Сортировка по количеству новых рефералов
  @@index([isPaid, weekEnd])
}

// Модель истории транзакций
model Transaction {
  id          Int      @id @default(autoincrement())
  userId      Int
  amount      Int      // Положительное - пополнение, отрицательное - списание
  type        String   // "deposit", "withdrawal", "referral_bonus", "video_generation"
  description String?  // Описание транзакции
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

// Модель голосования за видео
model Vote {
  id          Int      @id @default(autoincrement())
  videoId     Int
  userId      Int
  createdAt   DateTime @default(now())
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId]) // Один пользователь может проголосовать за видео только один раз
  @@index([videoId])
}